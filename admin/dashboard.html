<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ComfyUI Admin</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg width=%2284%22 height=%2284%22 viewBox=%220 0 84 84%22 fill=%22none%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Crect width=%2284%22 height=%2284%22 fill=%22%23172DD7%22/%3E%3Cpath d=%22M28.5899 69.2727C27.3242 69.2727 26.303 68.8023 25.637 67.9128C24.9524 66.9989 24.774 65.723 25.1471 64.4133L26.6455 59.1518C26.765 58.7329 26.6818 58.2821 26.4212 57.9336C26.1606 57.5858 25.7529 57.381 25.3198 57.381H21.0116C19.7453 57.381 18.724 56.9112 18.0583 56.0218C17.3738 55.1072 17.1953 53.8314 17.5687 52.5216L22.7163 34.5286L23.2847 32.5517C24.0487 29.869 26.8349 27.6888 29.4966 27.6888H34.6517C35.2668 27.6888 35.8079 27.2787 35.9773 26.6835L37.6821 20.6987C38.4453 18.0187 41.2316 15.8385 43.8933 15.8385L54.9181 15.8189L62.9891 15.8182C64.2551 15.8182 65.2763 16.288 65.942 17.1774C66.6265 18.0913 66.805 19.3672 66.4319 20.6769L64.124 28.7803C63.3611 31.4595 60.5748 33.6391 57.9131 33.6391L46.8637 33.6601H41.7104C41.0959 33.6601 40.5555 34.0695 40.3851 34.6641L36.0883 49.6722C35.9681 50.0919 36.0513 50.5441 36.3126 50.8925C36.5732 51.2403 36.9809 51.445 37.4136 51.445L44.7152 51.4308H52.7622C54.0282 51.4308 55.0494 51.9006 55.7151 52.7901C56.3996 53.7046 56.5781 54.9805 56.2047 56.2902L53.8969 64.3923C53.1339 67.0722 50.3476 69.2517 47.686 69.2517L36.6369 69.2727H28.5899Z%22 fill=%22%23F0FF41%22/%3E%3C/svg%3E">
<style>
/* ============================================================
   ComfyUI-inspired Admin Dashboard
   Dark theme matching the ComfyUI node editor aesthetic
   ============================================================ */

:root {
  --bg-canvas: #1a1a2e;
  --bg-panel: #222236;
  --bg-card: #2a2a40;
  --bg-card-hover: #32324a;
  --bg-input: #1e1e32;
  --bg-header: #16162a;
  --border: #3a3a55;
  --border-light: #44446a;
  --text: #e2e8f0;
  --text-dim: #8892a8;
  --text-muted: #5a6078;
  --accent: #00d4aa;
  --accent-dim: rgba(0,212,170,0.15);
  --accent-blue: #6366f1;
  --accent-purple: #a855f7;
  --accent-amber: #f59e0b;
  --accent-red: #ef4444;
  --accent-green: #22c55e;
  --node-green: #4ade80;
  --node-blue: #60a5fa;
  --node-purple: #c084fc;
  --node-orange: #fb923c;
  --radius: 8px;
  --radius-lg: 12px;
  --shadow: 0 4px 24px rgba(0,0,0,0.3);
  --font-mono: 'SF Mono', 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-canvas);
  color: var(--text);
  min-height: 100vh;
  /* Subtle dot grid like ComfyUI's node editor canvas */
  background-image: radial-gradient(circle, rgba(255,255,255,0.03) 1px, transparent 1px);
  background-size: 24px 24px;
}

/* ---- Header ---- */
.header {
  background: var(--bg-header);
  border-bottom: 1px solid var(--border);
  padding: 0 24px;
  display: flex;
  align-items: center;
  height: 56px;
  position: sticky;
  top: 0;
  z-index: 100;
}

.logo {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-right: 32px;
  flex-shrink: 0;
}

/* Node-connection dots in logo - ComfyUI inspired */
.logo-nodes {
  display: flex;
  align-items: center;
  gap: 4px;
}
.logo-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  border: 2px solid;
}
.logo-dot.d1 { border-color: var(--node-green); background: rgba(74,222,128,0.3); }
.logo-dot.d2 { border-color: var(--node-blue); background: rgba(96,165,250,0.3); }
.logo-dot.d3 { border-color: var(--node-purple); background: rgba(192,132,252,0.3); }
.logo-line {
  width: 16px;
  height: 2px;
  background: linear-gradient(90deg, var(--node-green), var(--node-blue));
  border-radius: 1px;
}
.logo-line2 {
  width: 16px;
  height: 2px;
  background: linear-gradient(90deg, var(--node-blue), var(--node-purple));
  border-radius: 1px;
}

.logo-text {
  font-size: 16px;
  font-weight: 700;
  letter-spacing: -0.5px;
}
.logo-text span { color: var(--accent); }

/* ---- Tab Navigation ---- */
.nav-tabs {
  display: flex;
  gap: 4px;
  flex: 1;
}
.tab-btn {
  background: transparent;
  border: none;
  color: var(--text-dim);
  padding: 8px 16px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}
.tab-btn:hover { background: var(--bg-card); color: var(--text); }
.tab-btn.active {
  background: var(--accent-dim);
  color: var(--accent);
}
.tab-icon { font-size: 15px; }

/* ---- Header Toggles ---- */
.header-toggles {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-left: auto;
  margin-right: 16px;
}
.toggle-group {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  color: var(--text-dim);
}
.toggle-group label { cursor: pointer; white-space: nowrap; }
.toggle-switch {
  position: relative;
  width: 34px;
  height: 18px;
  flex-shrink: 0;
}
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.toggle-slider {
  position: absolute;
  inset: 0;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 9px;
  cursor: pointer;
  transition: background 0.2s;
}
.toggle-slider::before {
  content: '';
  position: absolute;
  width: 12px;
  height: 12px;
  left: 2px;
  top: 2px;
  background: var(--text-dim);
  border-radius: 50%;
  transition: transform 0.2s, background 0.2s;
}
.toggle-switch input:checked + .toggle-slider {
  background: var(--accent-dim);
  border-color: var(--accent);
}
.toggle-switch input:checked + .toggle-slider::before {
  transform: translateX(16px);
  background: var(--accent);
}
.toggle-mode-label {
  font-family: var(--font-mono);
  font-size: 10px;
  min-width: 32px;
}

/* Live indicator */
.live-indicator {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--text-dim);
}
.live-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--accent-green);
  animation: pulse-live 2s infinite;
}
.live-dot.disconnected { background: var(--accent-amber); animation: none; }
@keyframes pulse-live { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

/* ---- Main Content ---- */
.main { padding: 20px 24px; max-width: 1600px; margin: 0 auto; }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* ---- Cards Grid ---- */
.cards-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}

/* Node-styled cards */
.node-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
  transition: border-color 0.2s, transform 0.15s;
}
.node-card:hover { border-color: var(--border-light); }

.node-header {
  padding: 10px 16px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.node-header.green { background: rgba(74,222,128,0.12); color: var(--node-green); }
.node-header.blue { background: rgba(96,165,250,0.12); color: var(--node-blue); }
.node-header.purple { background: rgba(192,132,252,0.12); color: var(--node-purple); }
.node-header.orange { background: rgba(251,146,60,0.12); color: var(--node-orange); }
.node-header.red { background: rgba(239,68,68,0.12); color: var(--accent-red); }
.node-header.teal { background: var(--accent-dim); color: var(--accent); }

/* Status port dot - like ComfyUI node connection points */
.port {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  border: 2px solid currentColor;
  flex-shrink: 0;
}
.port.filled { background: currentColor; }
.port.glow { box-shadow: 0 0 6px currentColor; }

.node-body { padding: 16px; }
.node-value {
  font-size: 32px;
  font-weight: 700;
  line-height: 1;
  margin-bottom: 4px;
}
.node-label {
  font-size: 12px;
  color: var(--text-dim);
}
.node-detail {
  font-size: 11px;
  color: var(--text-muted);
  font-family: var(--font-mono);
  margin-top: 8px;
}

/* ---- Panels ---- */
.panels-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 20px;
}
.panels-row.wide { grid-template-columns: 2fr 1fr; }
.panels-row.full { grid-template-columns: 1fr; }

.panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
}
.panel-header {
  padding: 12px 16px;
  font-size: 13px;
  font-weight: 600;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.panel-body { padding: 16px; }
.panel-body.scroll { max-height: 500px; overflow-y: auto; }

/* ---- Container List ---- */
.container-row {
  display: flex;
  align-items: center;
  padding: 8px 12px;
  border-radius: 6px;
  margin-bottom: 4px;
  font-size: 13px;
  transition: background 0.15s;
}
.container-row:hover { background: var(--bg-card-hover); }

.container-name {
  flex: 1;
  font-family: var(--font-mono);
  font-size: 12px;
}
.container-status {
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  margin-right: 8px;
}
.container-status.running { background: rgba(34,197,94,0.15); color: var(--accent-green); }
.container-status.exited { background: rgba(239,68,68,0.15); color: var(--accent-red); }
.container-status.restarting { background: rgba(245,158,11,0.15); color: var(--accent-amber); }
.container-status.created { background: rgba(99,102,241,0.15); color: var(--accent-blue); }

.container-health {
  font-size: 11px;
  color: var(--text-muted);
  margin-right: 12px;
  min-width: 60px;
}

.container-actions {
  display: flex;
  gap: 4px;
  opacity: 0;
  transition: opacity 0.15s;
}
.container-row:hover .container-actions { opacity: 1; }

/* ---- Buttons ---- */
.btn {
  padding: 5px 10px;
  border: 1px solid var(--border);
  border-radius: 5px;
  font-size: 11px;
  font-weight: 500;
  cursor: pointer;
  background: var(--bg-panel);
  color: var(--text-dim);
  transition: all 0.15s;
}
.btn:hover { background: var(--bg-card-hover); color: var(--text); border-color: var(--border-light); }
.btn.danger:hover { border-color: var(--accent-red); color: var(--accent-red); }
.btn.primary {
  background: var(--accent-dim);
  border-color: rgba(0,212,170,0.3);
  color: var(--accent);
}
.btn.primary:hover { background: rgba(0,212,170,0.25); }

.btn-lg {
  padding: 10px 20px;
  font-size: 13px;
  border-radius: var(--radius);
}

/* ---- GPU Cards ---- */
.gpu-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 16px;
  margin-top: 16px;
}

.gpu-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 20px;
  position: relative;
  transition: all 0.2s;
}
.gpu-card:hover { border-color: var(--border-light); transform: translateY(-2px); }
.gpu-card.active {
  border-color: var(--accent);
  box-shadow: 0 0 20px rgba(0,212,170,0.1);
}
.gpu-card.active::before {
  content: 'ACTIVE';
  position: absolute;
  top: 12px;
  right: 12px;
  font-size: 10px;
  font-weight: 700;
  color: var(--accent);
  background: var(--accent-dim);
  padding: 2px 8px;
  border-radius: 4px;
  letter-spacing: 0.5px;
}

.gpu-name { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
.gpu-chip {
  font-size: 12px;
  color: var(--text-dim);
  font-family: var(--font-mono);
  margin-bottom: 12px;
}
.gpu-price {
  font-size: 28px;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 4px;
}
.gpu-price-note {
  font-size: 11px;
  color: var(--text-muted);
  margin-bottom: 12px;
}
.gpu-specs {
  font-size: 12px;
  color: var(--text-dim);
  margin-bottom: 16px;
  line-height: 1.6;
}
.gpu-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.gpu-badge.spot { background: rgba(34,197,94,0.15); color: var(--accent-green); }
.gpu-badge.on-demand { background: rgba(99,102,241,0.15); color: var(--accent-blue); }

/* ---- Storage ---- */
.disk-bar-container {
  background: var(--bg-input);
  border-radius: 6px;
  height: 20px;
  overflow: hidden;
  margin: 8px 0;
}
.disk-bar {
  height: 100%;
  border-radius: 6px;
  background: linear-gradient(90deg, var(--accent), var(--accent-blue));
  transition: width 0.5s ease;
}
.disk-bar.warning { background: linear-gradient(90deg, var(--accent-amber), var(--accent-red)); }

.storage-table {
  width: 100%;
  border-collapse: collapse;
}
.storage-table th {
  text-align: left;
  padding: 8px 12px;
  font-size: 11px;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 1px solid var(--border);
}
.storage-table td {
  padding: 8px 12px;
  font-size: 13px;
  border-bottom: 1px solid rgba(58,58,85,0.3);
}
.storage-table td.mono { font-family: var(--font-mono); font-size: 12px; }
.storage-table tr:hover td { background: var(--bg-card-hover); }

/* R2 Bucket cards */
.r2-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 12px;
}
.r2-card {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px;
}
.r2-name {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--accent);
  margin-bottom: 8px;
  word-break: break-all;
}
.r2-stat { font-size: 13px; margin-bottom: 2px; }
.r2-stat .val { font-weight: 600; }

/* Directory browser */
.browser-path {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 8px 12px;
  background: var(--bg-input);
  border-radius: 6px;
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-dim);
  margin-bottom: 12px;
}
.browser-crumb {
  cursor: pointer;
  color: var(--accent);
  padding: 2px 4px;
  border-radius: 3px;
}
.browser-crumb:hover { background: var(--accent-dim); }

.browser-row {
  display: flex;
  align-items: center;
  padding: 6px 12px;
  border-radius: 5px;
  font-size: 13px;
  cursor: pointer;
  transition: background 0.15s;
}
.browser-row:hover { background: var(--bg-card-hover); }
.browser-icon { margin-right: 8px; font-size: 14px; }
.browser-name { flex: 1; }
.browser-name.dir { color: var(--node-blue); }
.browser-size { color: var(--text-muted); font-family: var(--font-mono); font-size: 11px; }

/* ---- Queue Tab ---- */
.job-item {
  padding: 12px;
  margin-bottom: 6px;
  border-radius: var(--radius);
  background: var(--bg-panel);
  border-left: 3px solid var(--border);
  transition: all 0.15s;
}
.job-item:hover { background: var(--bg-card-hover); }
.job-item.pending { border-left-color: var(--accent-amber); }
.job-item.running { border-left-color: var(--accent-green); }
.job-item.completed { border-left-color: var(--text-muted); opacity: 0.7; }
.job-item.failed { border-left-color: var(--accent-red); }

.job-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}
.job-id { font-weight: 600; font-family: var(--font-mono); font-size: 12px; }
.job-badge {
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
}
.job-badge.pending { background: rgba(245,158,11,0.15); color: var(--accent-amber); }
.job-badge.running { background: rgba(34,197,94,0.15); color: var(--accent-green); }
.job-badge.completed { background: rgba(99,102,241,0.15); color: var(--accent-blue); }
.job-badge.failed { background: rgba(239,68,68,0.15); color: var(--accent-red); }

.job-info { font-size: 12px; color: var(--text-dim); display: flex; gap: 12px; }
.job-actions { margin-top: 8px; display: flex; gap: 6px; }

/* ---- Log Viewer ---- */
.log-viewer {
  background: #0d0d1a;
  border-radius: var(--radius);
  padding: 12px;
  font-family: var(--font-mono);
  font-size: 11px;
  line-height: 1.6;
  max-height: 400px;
  overflow-y: auto;
  white-space: pre-wrap;
  word-break: break-all;
  color: var(--text-dim);
}

/* ---- Dialog / Modal ---- */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 200;
  backdrop-filter: blur(4px);
}
.modal {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 24px;
  min-width: 400px;
  max-width: 500px;
  box-shadow: var(--shadow);
}
.modal h3 { margin-bottom: 12px; font-size: 16px; }
.modal p { font-size: 13px; color: var(--text-dim); margin-bottom: 16px; line-height: 1.5; }
.modal-actions { display: flex; gap: 8px; justify-content: flex-end; }

/* ---- Toast ---- */
.toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 300; }
.toast {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px 16px;
  margin-top: 8px;
  font-size: 13px;
  box-shadow: var(--shadow);
  animation: toast-in 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}
.toast.success { border-left: 3px solid var(--accent-green); }
.toast.error { border-left: 3px solid var(--accent-red); }
.toast.info { border-left: 3px solid var(--accent-blue); }
@keyframes toast-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* ---- Empty State ---- */
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-muted);
}
.empty-state .icon { font-size: 32px; margin-bottom: 8px; opacity: 0.4; }

/* ---- Loading spinner ---- */
.spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ---- Responsive ---- */
@media (max-width: 1024px) {
  .panels-row, .panels-row.wide { grid-template-columns: 1fr; }
  .gpu-grid { grid-template-columns: 1fr 1fr; }
}
@media (max-width: 640px) {
  .header { padding: 0 12px; }
  .main { padding: 12px; }
  .gpu-grid { grid-template-columns: 1fr; }
  .cards-row { grid-template-columns: 1fr 1fr; }
  .tab-btn span.tab-label { display: none; }
}

/* ---- Templates Tab ---- */
.tpl-workflow-card {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  margin-bottom: 16px;
  overflow: hidden;
}
.tpl-workflow-header {
  padding: 12px 16px;
  font-size: 13px;
  font-weight: 600;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--bg-card);
}
.tpl-workflow-header .tpl-filename {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--accent);
}
.tpl-workflow-header .tpl-counts {
  font-size: 11px;
  color: var(--text-dim);
}
.tpl-subgraphs {
  padding: 8px 16px;
  font-size: 12px;
  color: var(--text-dim);
  border-bottom: 1px solid rgba(58,58,85,0.3);
}
.tpl-subgraphs span {
  display: inline-block;
  background: var(--accent-dim);
  color: var(--accent);
  padding: 2px 8px;
  border-radius: 4px;
  margin: 2px 4px 2px 0;
  font-size: 11px;
  font-weight: 500;
}
.tpl-model-row {
  display: flex;
  align-items: center;
  padding: 8px 16px;
  font-size: 12px;
  border-bottom: 1px solid rgba(58,58,85,0.15);
  gap: 12px;
}
.tpl-model-row:last-child { border-bottom: none; }
.tpl-model-row:hover { background: var(--bg-card-hover); }
.tpl-model-path {
  flex: 1;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text);
  word-break: break-all;
}
.tpl-badge {
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  white-space: nowrap;
  flex-shrink: 0;
}
.tpl-badge.on-disk { background: rgba(34,197,94,0.15); color: var(--accent-green); }
.tpl-badge.missing { background: rgba(239,68,68,0.15); color: var(--accent-red); }
.tpl-size {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  min-width: 70px;
  text-align: right;
  flex-shrink: 0;
}
.tpl-copy-btn {
  padding: 3px 8px;
  border: 1px solid var(--border);
  border-radius: 4px;
  font-size: 10px;
  cursor: pointer;
  background: var(--bg-input);
  color: var(--text-dim);
  transition: all 0.15s;
  white-space: nowrap;
  flex-shrink: 0;
}
.tpl-copy-btn:hover { background: var(--bg-card-hover); color: var(--text); border-color: var(--border-light); }
.tpl-no-url { font-size: 10px; color: var(--text-muted); font-style: italic; flex-shrink: 0; }

/* ---- Download UI ---- */
.dl-progress-panel {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 16px;
  margin-bottom: 16px;
}
.dl-status-bar {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}
.dl-status-bar .dl-filename {
  flex: 1;
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.dl-progress-bar-container {
  width: 200px;
  height: 16px;
  background: var(--bg-input);
  border-radius: 8px;
  overflow: hidden;
  flex-shrink: 0;
}
.dl-progress-bar {
  height: 100%;
  border-radius: 8px;
  background: linear-gradient(90deg, var(--accent-green), var(--accent-blue));
  transition: width 0.3s ease;
}
.dl-pct {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-dim);
  min-width: 45px;
  text-align: right;
  flex-shrink: 0;
}
.dl-file-counter {
  font-size: 12px;
  color: var(--text-dim);
  flex-shrink: 0;
}
.dl-console {
  background: #0d0d1a;
  border-radius: var(--radius);
  padding: 10px;
  font-family: var(--font-mono);
  font-size: 11px;
  line-height: 1.5;
  max-height: 300px;
  overflow-y: auto;
  white-space: pre-wrap;
  word-break: break-all;
  color: var(--text-dim);
}
.dl-console .dl-log-error { color: var(--accent-red); }
.dl-console .dl-log-ok { color: var(--accent-green); }
.dl-actions {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  align-items: center;
}
.tpl-gated-warning {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 10px;
  font-weight: 600;
  background: rgba(245,158,11,0.15);
  color: var(--accent-amber);
  text-transform: uppercase;
  white-space: nowrap;
  flex-shrink: 0;
}
.tpl-gated-warning a {
  color: var(--accent-amber);
  text-decoration: underline;
}
.tpl-dl-btn {
  padding: 3px 8px;
  border: 1px solid rgba(0,212,170,0.3);
  border-radius: 4px;
  font-size: 10px;
  cursor: pointer;
  background: var(--accent-dim);
  color: var(--accent);
  transition: all 0.15s;
  white-space: nowrap;
  flex-shrink: 0;
}
.tpl-dl-btn:hover { background: rgba(0,212,170,0.25); }

/* Scrollbar styling */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--border-light); }
</style>
</head>
<body>

<!-- ============================================================ -->
<!-- Header with ComfyUI node-connection logo -->
<!-- ============================================================ -->
<header class="header">
  <div class="logo">
    <div class="logo-nodes">
      <div class="logo-dot d1"></div>
      <div class="logo-line"></div>
      <div class="logo-dot d2"></div>
      <div class="logo-line2"></div>
      <div class="logo-dot d3"></div>
    </div>
    <div class="logo-text">Comfy<span>Admin</span></div>
  </div>

  <nav class="nav-tabs">
    <button class="tab-btn active" data-tab="system">
      <span class="tab-icon">&#9881;</span>
      <span class="tab-label">System</span>
    </button>
    <button class="tab-btn" data-tab="gpu">
      <span class="tab-icon">&#9889;</span>
      <span class="tab-label">GPU</span>
    </button>
    <button class="tab-btn" data-tab="storage">
      <span class="tab-icon">&#9633;</span>
      <span class="tab-label">Storage</span>
    </button>
    <button class="tab-btn" data-tab="queue">
      <span class="tab-icon">&#9776;</span>
      <span class="tab-label">Queue</span>
    </button>
    <button class="tab-btn" data-tab="templates">
      <span class="tab-icon">&#9741;</span>
      <span class="tab-label">Templates</span>
    </button>
  </nav>

  <div class="header-toggles">
    <div class="toggle-group">
      <label for="toggle-overlay">Overlay</label>
      <div class="toggle-switch">
        <input type="checkbox" id="toggle-overlay">
        <span class="toggle-slider"></span>
      </div>
      <span id="overlay-mode-label" class="toggle-mode-label">user</span>
    </div>
    <div class="toggle-group">
      <label for="toggle-features">Features</label>
      <div class="toggle-switch">
        <input type="checkbox" id="toggle-features" checked>
        <span class="toggle-slider"></span>
      </div>
      <span id="features-mode-label" class="toggle-mode-label">on</span>
    </div>
  </div>

  <div class="live-indicator">
    <div class="live-dot" id="live-dot"></div>
    <span id="live-text">Connecting...</span>
  </div>
</header>

<!-- ============================================================ -->
<!-- Main Content Area -->
<!-- ============================================================ -->
<main class="main">

  <!-- ===================== SYSTEM TAB ===================== -->
  <div id="tab-system" class="tab-content active">

    <!-- Status Cards -->
    <div class="cards-row" id="status-cards">
      <div class="node-card">
        <div class="node-header green">
          <div class="port" id="redis-port"></div>
          Redis
        </div>
        <div class="node-body">
          <div class="node-value" id="redis-status">--</div>
          <div class="node-label">Job Queue</div>
          <div class="node-detail" id="redis-detail"></div>
        </div>
      </div>

      <div class="node-card">
        <div class="node-header blue">
          <div class="port" id="qm-port"></div>
          Queue Manager
        </div>
        <div class="node-body">
          <div class="node-value" id="qm-status">--</div>
          <div class="node-label">FastAPI Service</div>
          <div class="node-detail" id="qm-detail"></div>
        </div>
      </div>

      <div class="node-card">
        <div class="node-header purple">
          <div class="port" id="gpu-port"></div>
          Serverless GPU
        </div>
        <div class="node-body">
          <div class="node-value" id="gpu-status-card">--</div>
          <div class="node-label" id="gpu-label">Inference</div>
          <div class="node-detail" id="gpu-detail"></div>
        </div>
      </div>

      <div class="node-card">
        <div class="node-header orange">
          <div class="port filled" id="disk-port"></div>
          Disk Usage
        </div>
        <div class="node-body">
          <div class="node-value" id="disk-value">--</div>
          <div class="node-label" id="disk-label">Loading...</div>
          <div class="disk-bar-container" style="margin-top:8px">
            <div class="disk-bar" id="disk-bar" style="width:0%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Containers & Logs -->
    <div class="panels-row wide">
      <div class="panel">
        <div class="panel-header">
          <span>Containers</span>
          <button class="btn" onclick="loadContainers()">Refresh</button>
        </div>
        <div class="panel-body scroll" id="container-list">
          <div class="empty-state"><div class="spinner"></div><br>Loading containers...</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <span>Logs</span>
          <select id="log-select" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text);border-radius:4px;padding:4px 8px;font-size:12px">
            <option value="">Select container...</option>
          </select>
        </div>
        <div class="panel-body">
          <div class="log-viewer" id="log-viewer">Select a container to view logs.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== GPU TAB ===================== -->
  <div id="tab-gpu" class="tab-content">

    <!-- Current GPU Status -->
    <div class="panels-row full">
      <div class="panel">
        <div class="panel-header">
          <span>Current GPU Deployment</span>
          <span id="gpu-mode-badge" class="gpu-badge spot">Loading...</span>
        </div>
        <div class="panel-body">
          <div style="display:flex;align-items:center;gap:16px;margin-bottom:8px">
            <span style="font-size:24px;font-weight:700" id="gpu-current-name">Loading...</span>
            <span style="font-size:14px;color:var(--text-dim)" id="gpu-current-endpoint"></span>
          </div>
          <div style="font-size:13px;color:var(--text-dim)" id="gpu-current-info">
            Fetching GPU status...
          </div>
        </div>
      </div>
    </div>

    <!-- GPU Options -->
    <h3 style="font-size:14px;color:var(--text-dim);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.5px">Available Deployments</h3>
    <div class="gpu-grid" id="gpu-grid">
      <!-- Populated by JS -->
    </div>

    <div style="margin-top:16px">
      <button class="btn" onclick="switchGpu('local')" style="margin-right:8px">Switch to Local/Redis Mode</button>
      <span style="font-size:12px;color:var(--text-muted)">Disables serverless, uses local GPU workers polling Redis queue</span>
    </div>
  </div>

  <!-- ===================== STORAGE TAB ===================== -->
  <div id="tab-storage" class="tab-content">

    <!-- Disk Overview -->
    <div class="panels-row">
      <div class="panel">
        <div class="panel-header">
          <span>Disk Usage</span>
          <button class="btn" onclick="loadStorageDisk()">Refresh</button>
        </div>
        <div class="panel-body" id="storage-disk-panel">
          <div class="empty-state"><div class="spinner"></div><br>Loading...</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <span>R2 Cloud Storage</span>
          <button class="btn" onclick="loadStorageR2()">Refresh</button>
        </div>
        <div class="panel-body" id="storage-r2-panel">
          <div class="empty-state"><div class="spinner"></div><br>Loading...</div>
        </div>
      </div>
    </div>

    <!-- Directory Browser -->
    <div class="panels-row full">
      <div class="panel">
        <div class="panel-header">
          <span>Directory Browser</span>
        </div>
        <div class="panel-body">
          <div class="browser-path" id="browser-path"></div>
          <div id="browser-entries">
            <div class="empty-state">Click refresh to load directory listing.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== QUEUE TAB ===================== -->
  <div id="tab-queue" class="tab-content">
    <div class="cards-row">
      <div class="node-card">
        <div class="node-header teal"><div class="port filled glow"></div> Pending</div>
        <div class="node-body"><div class="node-value" id="q-pending">-</div><div class="node-label">Jobs in queue</div></div>
      </div>
      <div class="node-card">
        <div class="node-header green"><div class="port filled glow"></div> Running</div>
        <div class="node-body"><div class="node-value" id="q-running">-</div><div class="node-label">Processing</div></div>
      </div>
      <div class="node-card">
        <div class="node-header blue"><div class="port filled"></div> Completed</div>
        <div class="node-body"><div class="node-value" id="q-completed">-</div><div class="node-label">Finished</div></div>
      </div>
      <div class="node-card">
        <div class="node-header red"><div class="port filled"></div> Failed</div>
        <div class="node-body"><div class="node-value" id="q-failed">-</div><div class="node-label">Errors</div></div>
      </div>
    </div>

    <div class="panels-row full">
      <div class="panel">
        <div class="panel-header">
          <span>Job Queue</span>
          <button class="btn" onclick="loadJobs()">Refresh</button>
        </div>
        <div class="panel-body scroll" id="job-list">
          <div class="empty-state"><div class="spinner"></div><br>Loading jobs...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== TEMPLATES TAB ===================== -->
  <div id="tab-templates" class="tab-content">

    <!-- Summary Cards -->
    <div class="cards-row" id="tpl-cards">
      <div class="node-card">
        <div class="node-header teal"><div class="port filled"></div> Workflows</div>
        <div class="node-body"><div class="node-value" id="tpl-wf-count">-</div><div class="node-label">Template files</div></div>
      </div>
      <div class="node-card">
        <div class="node-header green"><div class="port filled"></div> On Disk</div>
        <div class="node-body"><div class="node-value" id="tpl-on-disk">-</div><div class="node-label">Models found</div></div>
      </div>
      <div class="node-card">
        <div class="node-header red"><div class="port filled"></div> Missing</div>
        <div class="node-body"><div class="node-value" id="tpl-missing">-</div><div class="node-label">Models needed</div></div>
      </div>
      <div class="node-card">
        <div class="node-header orange"><div class="port filled"></div> Disk Free</div>
        <div class="node-body"><div class="node-value" id="tpl-disk-free">-</div><div class="node-label" id="tpl-disk-label">GB available</div></div>
      </div>
    </div>

    <!-- Download Progress Panel (hidden until active) -->
    <div id="dl-panel" style="display:none">
      <div class="dl-progress-panel">
        <div class="dl-status-bar">
          <span class="dl-filename" id="dl-filename">Waiting...</span>
          <div class="dl-progress-bar-container">
            <div class="dl-progress-bar" id="dl-progress-bar" style="width:0%"></div>
          </div>
          <span class="dl-pct" id="dl-pct">0%</span>
          <span class="dl-file-counter" id="dl-file-counter">0/0</span>
        </div>
        <div class="dl-console" id="dl-console"></div>
        <div class="dl-actions">
          <button class="btn danger" id="dl-cancel-btn" onclick="cancelDownload()">Cancel</button>
          <span id="dl-size-info" style="font-size:12px;color:var(--text-dim)"></span>
        </div>
      </div>
    </div>

    <!-- Workflow Panels -->
    <div class="panels-row full">
      <div class="panel">
        <div class="panel-header">
          <span>Workflow Templates</span>
          <div style="display:flex;gap:6px">
            <button class="btn primary" onclick="loadTemplates()">Scan</button>
            <button class="btn" id="btn-check-dl" onclick="checkModels()" style="display:none">Check Models</button>
            <button class="btn primary" id="btn-dl-all" onclick="downloadAllMissing()" style="display:none">Download All Missing</button>
          </div>
        </div>
        <div class="panel-body" id="tpl-workflows">
          <div class="empty-state">Click <strong>Scan</strong> to discover workflow templates and their model dependencies.</div>
        </div>
      </div>
    </div>
  </div>

</main>

<!-- Toast container -->
<div class="toast-container" id="toast-container"></div>

<!-- Confirmation modal (hidden) -->
<div class="modal-overlay" id="modal" style="display:none">
  <div class="modal">
    <h3 id="modal-title">Confirm</h3>
    <p id="modal-body">Are you sure?</p>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn primary" id="modal-confirm" onclick="confirmModal()">Confirm</button>
    </div>
  </div>
</div>


<script>
/* ============================================================
   ComfyUI Admin Dashboard - JavaScript
   ============================================================ */

// Detect base path for API calls (works behind nginx proxy at /admin/)
const BASE = window.location.pathname.replace(/\/+$/, '');

// State
let currentTab = 'system';
let containers = [];
let modalCallback = null;
let pollInterval = null;

// HTML escape to prevent XSS
function esc(s) {
  if (s == null) return '';
  const d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}

// ---- Tab Navigation ----
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    document.getElementById('tab-' + tab).classList.add('active');
    currentTab = tab;
    // Load data for the selected tab
    if (tab === 'gpu') loadGpuStatus();
    if (tab === 'storage') { loadStorageDisk(); loadStorageR2(); browseTo('/'); }
    if (tab === 'queue') { loadQueueStatus(); loadJobs(); }
    if (tab === 'templates') { loadTemplates(); checkActiveDownload(); }
  });
});

// ---- Header Toggles ----
// GPU overlay mode: 'admin' shows detailed info, 'user' shows minimal
const overlayToggle = document.getElementById('toggle-overlay');
const overlayLabel = document.getElementById('overlay-mode-label');
overlayToggle.checked = localStorage.getItem('gpu_overlay_mode') === 'admin';
overlayLabel.textContent = overlayToggle.checked ? 'admin' : 'user';
overlayToggle.addEventListener('change', () => {
  const mode = overlayToggle.checked ? 'admin' : 'user';
  localStorage.setItem('gpu_overlay_mode', mode);
  overlayLabel.textContent = mode;
});

// Admin features on/off: controls ADMIN_FEATURES_ENABLED via API
const featuresToggle = document.getElementById('toggle-features');
const featuresLabel = document.getElementById('features-mode-label');
featuresLabel.textContent = featuresToggle.checked ? 'on' : 'off';
featuresToggle.addEventListener('change', () => {
  featuresLabel.textContent = featuresToggle.checked ? 'on' : 'off';
  // TODO: POST to /api/admin/features { enabled: true/false } when backend supports it (#75)
});

// ---- API Helper ----
async function api(path, opts = {}) {
  const url = BASE + path;
  try {
    const resp = await fetch(url, opts);
    if (!resp.ok) {
      const err = await resp.json().catch(() => ({ detail: resp.statusText }));
      throw new Error(err.detail || resp.statusText);
    }
    if (resp.status === 204) return {};
    return await resp.json();
  } catch (e) {
    console.error('API error:', path, e);
    throw e;
  }
}

// ---- Toast Notifications ----
function toast(message, type = 'info') {
  const container = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = 'toast ' + type;
  t.textContent = message;
  container.appendChild(t);
  setTimeout(() => t.remove(), 4000);
}

// ---- Modal ----
function showModal(title, body, onConfirm) {
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-body').textContent = body;
  modalCallback = onConfirm;
  document.getElementById('modal').style.display = 'flex';
}
function closeModal() {
  document.getElementById('modal').style.display = 'none';
  modalCallback = null;
}
function confirmModal() {
  if (modalCallback) modalCallback();
  closeModal();
}


// ============================================================
// SYSTEM TAB
// ============================================================

async function loadSystemStatus() {
  try {
    const data = await api('/api/system/status');
    updateLive(true);

    // Redis
    const redis = data.services?.redis || {};
    const redisEl = document.getElementById('redis-status');
    const redisPort = document.getElementById('redis-port');
    const redisDetail = document.getElementById('redis-detail');
    if (redis.healthy) {
      redisEl.textContent = 'OK';
      redisEl.style.color = 'var(--accent-green)';
      redisPort.classList.add('filled', 'glow');
      const info = redis.info || {};
      redisDetail.textContent = `Memory: ${esc(info.used_memory_human || '?')} | Clients: ${info.connected_clients || 0}`;
    } else {
      redisEl.textContent = 'DOWN';
      redisEl.style.color = 'var(--accent-red)';
      redisPort.classList.remove('filled', 'glow');
      redisDetail.textContent = 'Connection failed';
    }

    // Queue Manager
    const qm = data.services?.queue_manager || {};
    const qmEl = document.getElementById('qm-status');
    const qmPort = document.getElementById('qm-port');
    const qmDetail = document.getElementById('qm-detail');
    if (qm.healthy) {
      qmEl.textContent = 'OK';
      qmEl.style.color = 'var(--accent-green)';
      qmPort.classList.add('filled', 'glow');
      const info = qm.info || {};
      qmDetail.textContent = `Mode: ${esc(info.inference_mode || '?')} | Queue: ${info.queue_depth || 0}`;
    } else {
      qmEl.textContent = 'DOWN';
      qmEl.style.color = 'var(--accent-red)';
      qmPort.classList.remove('filled', 'glow');
      qmDetail.textContent = 'Service unreachable';
    }

    // GPU / Serverless
    const qmInfo = data.services?.queue_manager?.info || {};
    const gpuEl = document.getElementById('gpu-status-card');
    const gpuPort = document.getElementById('gpu-port');
    const gpuLabel = document.getElementById('gpu-label');
    const gpuDetail = document.getElementById('gpu-detail');
    const gpuType = qmInfo.active_gpu || 'unknown';
    const mode = qmInfo.inference_mode || 'unknown';

    if (mode === 'serverless') {
      gpuEl.textContent = gpuType.replace(/-/g, ' ');
      gpuEl.style.color = 'var(--node-purple)';
      gpuPort.classList.add('filled', 'glow');
      gpuLabel.textContent = 'Serverless';
      gpuDetail.textContent = qmInfo.serverless_endpoint || '';
    } else if (mode === 'local' || mode === 'redis') {
      gpuEl.textContent = mode.toUpperCase();
      gpuEl.style.color = 'var(--accent-amber)';
      gpuPort.classList.add('filled');
      gpuPort.classList.remove('glow');
      gpuLabel.textContent = 'Local Workers';
      gpuDetail.textContent = 'Workers poll Redis queue';
    } else {
      gpuEl.textContent = '?';
      gpuEl.style.color = 'var(--text-muted)';
      gpuPort.classList.remove('filled', 'glow');
      gpuLabel.textContent = 'Unknown';
      gpuDetail.textContent = '';
    }

    // Disk
    const disk = data.disk || {};
    const diskVal = document.getElementById('disk-value');
    const diskLabel = document.getElementById('disk-label');
    const diskBar = document.getElementById('disk-bar');
    const diskPort = document.getElementById('disk-port');
    const pct = disk.percent_used || 0;
    diskVal.textContent = pct + '%';
    diskLabel.textContent = `${disk.used_gb || '?'} GB / ${disk.total_gb || '?'} GB`;
    diskBar.style.width = pct + '%';
    if (pct > 85) {
      diskBar.classList.add('warning');
      diskVal.style.color = 'var(--accent-red)';
      diskPort.style.color = 'var(--accent-red)';
    } else {
      diskBar.classList.remove('warning');
      diskVal.style.color = 'var(--node-orange)';
      diskPort.style.color = '';
    }
  } catch (e) {
    updateLive(false);
    console.error('System status failed:', e);
  }
}

async function loadContainers() {
  try {
    const data = await api('/api/containers');
    containers = data.containers || [];
    const list = document.getElementById('container-list');
    const select = document.getElementById('log-select');

    if (data.error && containers.length === 0) {
      list.innerHTML = `<div class="empty-state"><div class="icon">&#128268;</div><div>${esc(data.error)}</div></div>`;
      return;
    }

    if (containers.length === 0) {
      list.innerHTML = '<div class="empty-state"><div class="icon">&#128230;</div><div>No containers found</div></div>';
      return;
    }

    // Update log selector
    select.innerHTML = '<option value="">Select container...</option>' +
      containers.map(c => `<option value="${esc(c.name)}">${esc(c.name)}</option>`).join('');

    list.innerHTML = containers.map(c => `
      <div class="container-row">
        <span class="container-status ${esc(c.status)}">${esc(c.status)}</span>
        <span class="container-name">${esc(c.name)}</span>
        <span class="container-health">${c.health !== 'none' ? esc(c.health) : ''}</span>
        <div class="container-actions">
          ${c.status === 'running' ? `
            <button class="btn" onclick="containerAction('${esc(c.name)}','restart')">Restart</button>
            <button class="btn danger" onclick="containerAction('${esc(c.name)}','stop')">Stop</button>
          ` : `
            <button class="btn primary" onclick="containerAction('${esc(c.name)}','start')">Start</button>
          `}
          <button class="btn" onclick="viewLogs('${esc(c.name)}')">Logs</button>
        </div>
      </div>
    `).join('');
  } catch (e) {
    document.getElementById('container-list').innerHTML =
      `<div class="empty-state"><div class="icon">&#9888;</div><div>Failed to load: ${esc(e.message)}</div></div>`;
  }
}

async function containerAction(name, action) {
  if (action === 'stop') {
    showModal('Stop Container', `Stop ${name}? Users connected to this container will be disconnected.`, async () => {
      try {
        await api(`/api/containers/${name}/${action}`, { method: 'POST' });
        toast(`${name} stopped`, 'success');
        loadContainers();
      } catch (e) { toast(`Failed: ${e.message}`, 'error'); }
    });
    return;
  }
  try {
    await api(`/api/containers/${name}/${action}`, { method: 'POST' });
    toast(`${name} ${action}ed`, 'success');
    setTimeout(loadContainers, 2000); // Wait for container state change
  } catch (e) { toast(`Failed: ${e.message}`, 'error'); }
}

async function viewLogs(name) {
  document.getElementById('log-select').value = name;
  const viewer = document.getElementById('log-viewer');
  viewer.textContent = 'Loading...';
  try {
    const data = await api(`/api/containers/${name}/logs?lines=200`);
    viewer.textContent = data.logs || 'No logs available.';
    viewer.scrollTop = viewer.scrollHeight;
  } catch (e) {
    viewer.textContent = `Error: ${e.message}`;
  }
}

// Log select change handler
document.getElementById('log-select').addEventListener('change', (e) => {
  if (e.target.value) viewLogs(e.target.value);
});


// ============================================================
// GPU TAB
// ============================================================

async function loadGpuStatus() {
  try {
    const data = await api('/api/gpu/status');
    const current = data.current || {};
    const deployments = data.deployments || {};

    // Current status banner
    const mode = current.inference_mode || 'unknown';
    const active = current.serverless_active || current.active_gpu || 'unknown';
    const nameEl = document.getElementById('gpu-current-name');
    const endpointEl = document.getElementById('gpu-current-endpoint');
    const infoEl = document.getElementById('gpu-current-info');
    const badge = document.getElementById('gpu-mode-badge');

    if (mode === 'serverless' && deployments[active]) {
      const dep = deployments[active];
      nameEl.textContent = dep.name;
      endpointEl.textContent = current.serverless_endpoint || '';
      infoEl.textContent = `${dep.gpu} | ${dep.vram} | ${dep.bandwidth} bandwidth | ${dep.best_for}`;
      badge.textContent = dep.type.toUpperCase();
      badge.className = 'gpu-badge ' + (dep.type === 'spot' ? 'spot' : 'on-demand');
    } else if (mode === 'local' || mode === 'redis') {
      nameEl.textContent = 'Local / Redis Workers';
      endpointEl.textContent = '';
      infoEl.textContent = 'Workers poll Redis queue for jobs. No serverless endpoint active.';
      badge.textContent = 'LOCAL';
      badge.className = 'gpu-badge';
    } else {
      nameEl.textContent = active;
      endpointEl.textContent = '';
      infoEl.textContent = `Mode: ${mode}`;
      badge.textContent = mode.toUpperCase();
      badge.className = 'gpu-badge';
    }

    // Deployment cards
    const grid = document.getElementById('gpu-grid');
    grid.innerHTML = Object.entries(deployments).map(([key, dep]) => `
      <div class="gpu-card ${active === key ? 'active' : ''}">
        <div class="gpu-name">${esc(dep.name)}</div>
        <div class="gpu-chip">${esc(dep.gpu)} | ${esc(dep.vram)}</div>
        <div class="gpu-price">${esc(dep.price_label)}</div>
        <div class="gpu-price-note">
          <span class="gpu-badge ${dep.type === 'spot' ? 'spot' : 'on-demand'}">${esc(dep.type)}</span>
          + VAT
        </div>
        <div class="gpu-specs">
          Bandwidth: ${esc(dep.bandwidth)}<br>
          Best for: ${esc(dep.best_for)}
        </div>
        ${active !== key ? `<button class="btn primary btn-lg" onclick="switchGpu('${esc(key)}')" style="width:100%">Switch to ${esc(dep.name)}</button>` : ''}
      </div>
    `).join('');
  } catch (e) {
    toast('Failed to load GPU status: ' + e.message, 'error');
  }
}

function switchGpu(mode) {
  const label = mode === 'local' ? 'Local/Redis Workers' : mode;
  showModal(
    'Switch GPU Deployment',
    `Switch to ${label}? This will update .env and restart the queue manager. Active jobs may be affected.`,
    async () => {
      try {
        const data = await api('/api/gpu/switch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mode }),
        });
        toast(`Switched to ${mode}. Queue manager: ${data.queue_manager_restart}`, 'success');
        // Wait for restart then reload
        setTimeout(loadGpuStatus, 5000);
        setTimeout(loadSystemStatus, 5000);
      } catch (e) { toast('Switch failed: ' + e.message, 'error'); }
    }
  );
}


// ============================================================
// STORAGE TAB
// ============================================================

async function loadStorageDisk() {
  try {
    const data = await api('/api/storage/disk');
    const panel = document.getElementById('storage-disk-panel');
    const disk = data.disk || {};
    const dirs = data.directories || {};
    const pct = disk.percent_used || 0;

    let html = `
      <div style="margin-bottom:16px">
        <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px">
          <span>${disk.used_gb} GB used of ${disk.total_gb} GB</span>
          <span style="color:${pct > 85 ? 'var(--accent-red)' : 'var(--text-dim)'}">${pct}% used</span>
        </div>
        <div class="disk-bar-container">
          <div class="disk-bar ${pct > 85 ? 'warning' : ''}" style="width:${pct}%"></div>
        </div>
        <div style="font-size:12px;color:var(--text-muted)">${disk.free_gb} GB free</div>
      </div>
      <table class="storage-table">
        <thead><tr><th>Directory</th><th>Size</th><th>Files</th><th>Path</th></tr></thead>
        <tbody>
    `;
    for (const [label, info] of Object.entries(dirs)) {
      if (info.error) {
        html += `<tr><td>${esc(label)}</td><td colspan="3" style="color:var(--text-muted)">${esc(info.error)}</td></tr>`;
      } else {
        html += `<tr>
          <td>${esc(label)}</td>
          <td class="mono">${esc(info.size_human)}</td>
          <td>${info.file_count}</td>
          <td class="mono" style="color:var(--text-muted)">${esc(info.path)}</td>
        </tr>`;
      }
    }
    html += '</tbody></table>';
    panel.innerHTML = html;
  } catch (e) {
    document.getElementById('storage-disk-panel').innerHTML =
      `<div class="empty-state">Failed: ${esc(e.message)}</div>`;
  }
}

async function loadStorageR2() {
  try {
    const data = await api('/api/storage/r2');
    const panel = document.getElementById('storage-r2-panel');

    if (data.error && (!data.buckets || data.buckets.length === 0)) {
      panel.innerHTML = `<div class="empty-state"><div class="icon">&#9729;</div><div>${esc(data.error)}</div></div>`;
      return;
    }

    const buckets = data.buckets || [];
    panel.innerHTML = '<div class="r2-grid">' + buckets.map(b => {
      if (b.status === 'error') {
        return `<div class="r2-card">
          <div class="r2-name">${esc(b.name)}</div>
          <div class="r2-stat" style="color:var(--accent-red)">Error: ${esc(b.error)}</div>
        </div>`;
      }
      return `<div class="r2-card">
        <div class="r2-name">${esc(b.name)}</div>
        <div class="r2-stat"><span class="val">${esc(b.size_human)}</span></div>
        <div class="r2-stat" style="color:var(--text-dim)">${b.objects} objects</div>
      </div>`;
    }).join('') + '</div>';
  } catch (e) {
    document.getElementById('storage-r2-panel').innerHTML =
      `<div class="empty-state">Failed: ${esc(e.message)}</div>`;
  }
}

async function browseTo(path) {
  try {
    const data = await api('/api/storage/browse?path=' + encodeURIComponent(path));
    const pathEl = document.getElementById('browser-path');
    const entriesEl = document.getElementById('browser-entries');

    // Build breadcrumb path
    const parts = data.path.split('/').filter(Boolean);
    let crumbs = '<span class="browser-crumb" onclick="browseTo(\'/\')">root</span>';
    let built = '';
    for (const part of parts) {
      built += '/' + part;
      const p = built;
      crumbs += ` / <span class="browser-crumb" onclick="browseTo('${esc(p)}')">${esc(part)}</span>`;
    }
    pathEl.innerHTML = crumbs;

    // Entries
    const entries = data.entries || [];
    if (entries.length === 0) {
      entriesEl.innerHTML = '<div class="empty-state">Empty directory</div>';
      return;
    }

    entriesEl.innerHTML = (data.path !== '/' ? `
      <div class="browser-row" onclick="browseTo('${esc(data.path.replace(/\/[^\/]+$/, '') || '/')}')">
        <span class="browser-icon">&#8617;</span>
        <span class="browser-name">..</span>
      </div>
    ` : '') + entries.map(e => `
      <div class="browser-row" ${e.type === 'directory' ? `onclick="browseTo('${esc(e.path)}')"` : ''}>
        <span class="browser-icon">${e.type === 'directory' ? '&#128193;' : '&#128196;'}</span>
        <span class="browser-name ${e.type === 'directory' ? 'dir' : ''}">${esc(e.name)}</span>
        <span class="browser-size">${e.size_human ? esc(e.size_human) : ''}</span>
      </div>
    `).join('');
  } catch (e) {
    document.getElementById('browser-entries').innerHTML =
      `<div class="empty-state">${esc(e.message)}</div>`;
  }
}


// ============================================================
// QUEUE TAB
// ============================================================

async function loadQueueStatus() {
  try {
    const data = await api('/api/queue/status');
    document.getElementById('q-pending').textContent = data.pending_jobs ?? '-';
    document.getElementById('q-running').textContent = data.running_jobs ?? '-';
    document.getElementById('q-completed').textContent = data.completed_jobs ?? '-';
    document.getElementById('q-failed').textContent = data.failed_jobs ?? '-';
  } catch (e) {
    console.error('Queue status failed:', e);
  }
}

async function loadJobs() {
  try {
    const jobs = await api('/api/queue/jobs?limit=50');
    const list = document.getElementById('job-list');

    if (!Array.isArray(jobs) || jobs.length === 0) {
      list.innerHTML = '<div class="empty-state"><div class="icon">&#9989;</div><div>No jobs in queue</div></div>';
      return;
    }

    list.innerHTML = jobs.map(job => `
      <div class="job-item ${esc(job.status)}">
        <div class="job-header">
          <span class="job-id">Job ${esc((job.id || '').substring(0, 8))}</span>
          <span class="job-badge ${esc(job.status)}">${esc(job.status)}</span>
        </div>
        <div class="job-info">
          <span>User: ${esc(job.user_id)}</span>
          <span>${new Date(job.created_at).toLocaleTimeString()}</span>
          ${job.position_in_queue != null ? `<span>Pos: ${job.position_in_queue + 1}</span>` : ''}
          ${job.worker_id ? `<span>Worker: ${esc(job.worker_id)}</span>` : ''}
        </div>
        ${job.error ? `<div style="color:var(--accent-red);font-size:12px;margin-top:6px">${esc(job.error)}</div>` : ''}
        ${job.status === 'pending' || job.status === 'running' ? `
          <div class="job-actions">
            ${job.status === 'pending' ? `<button class="btn primary" onclick="prioritizeJob('${esc(job.id)}')">Prioritize</button>` : ''}
            <button class="btn danger" onclick="cancelJob('${esc(job.id)}')">Cancel</button>
          </div>
        ` : ''}
      </div>
    `).join('');
  } catch (e) {
    document.getElementById('job-list').innerHTML =
      `<div class="empty-state">Failed: ${esc(e.message)}</div>`;
  }
}

async function cancelJob(jobId) {
  showModal('Cancel Job', `Cancel job ${jobId.substring(0, 8)}?`, async () => {
    try {
      await api(`/api/queue/jobs/${jobId}`, { method: 'DELETE' });
      toast('Job cancelled', 'success');
      loadJobs();
      loadQueueStatus();
    } catch (e) { toast('Failed: ' + e.message, 'error'); }
  });
}

async function prioritizeJob(jobId) {
  try {
    await api(`/api/queue/jobs/${jobId}/priority`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ priority: 0 }),
    });
    toast('Job prioritized (instructor level)', 'success');
    loadJobs();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}


// ============================================================
// TEMPLATES TAB
// ============================================================

async function loadTemplates() {
  const panel = document.getElementById('tpl-workflows');
  panel.innerHTML = '<div class="empty-state"><div class="spinner"></div><br>Scanning workflows...</div>';

  try {
    const data = await api('/api/templates/scan');
    const workflows = data.workflows || [];
    const disk = data.disk || {};

    // Summary cards
    let totalOnDisk = 0, totalMissing = 0;
    workflows.forEach(wf => {
      totalOnDisk += wf.models_on_disk || 0;
      totalMissing += wf.models_missing || 0;
    });
    document.getElementById('tpl-wf-count').textContent = workflows.length;
    document.getElementById('tpl-on-disk').textContent = totalOnDisk;
    document.getElementById('tpl-missing').textContent = totalMissing;
    document.getElementById('tpl-missing').style.color = totalMissing > 0 ? 'var(--accent-red)' : 'var(--accent-green)';
    document.getElementById('tpl-disk-free').textContent = disk.free_gb != null ? disk.free_gb + '' : '?';
    document.getElementById('tpl-disk-label').textContent = disk.free_gb != null ? 'GB free of ' + disk.total_gb + ' GB' : 'GB available';

    // Show "Check Downloads" button (also checks for orphaned models)
    document.getElementById('btn-check-dl').style.display = '';

    if (workflows.length === 0) {
      panel.innerHTML = '<div class="empty-state">No workflow JSON files found in /workflows.</div>';
      return;
    }

    // Disk bar
    let diskBarHtml = '';
    if (disk.total_gb) {
      const pct = Math.round((disk.used_gb / disk.total_gb) * 100);
      diskBarHtml = `
        <div style="margin-bottom:16px">
          <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;color:var(--text-dim)">
            <span>Models disk: ${disk.used_gb} GB used of ${disk.total_gb} GB</span>
            <span>${disk.free_gb} GB free</span>
          </div>
          <div class="disk-bar-container">
            <div class="disk-bar ${pct > 85 ? 'warning' : ''}" style="width:${pct}%"></div>
          </div>
        </div>`;
    }

    // Workflow cards
    panel.innerHTML = diskBarHtml + workflows.map(wf => {
      if (wf.error) {
        return `<div class="tpl-workflow-card">
          <div class="tpl-workflow-header">
            <span class="tpl-filename">${esc(wf.filename)}</span>
            <span style="color:var(--accent-red);font-size:11px">Parse error: ${esc(wf.error)}</span>
          </div>
        </div>`;
      }

      const tplTags = (wf.templates || []).map(t =>
        `<span>${esc(t.name)}</span>`
      ).join('');

      const modelRows = (wf.models || []).map(m => {
        const path = (m.directory ? m.directory + '/' : '') + m.filename;
        if (m.on_disk) {
          return `<div class="tpl-model-row">
            <span class="tpl-badge on-disk">on disk</span>
            <span class="tpl-model-path">${esc(path)}</span>
            <span class="tpl-size">${m.file_size_human ? esc(m.file_size_human) : ''}</span>
          </div>`;
        } else {
          const dlBtn = m.url
            ? `<button class="tpl-dl-btn" onclick="downloadSingleModel('${esc(m.directory)}','${esc(m.filename)}','${esc(m.url).replace(/'/g, "\\'")}')">DL</button>`
            : '';
          const wgetBtn = m.url
            ? `<button class="tpl-copy-btn" onclick="copyDownloadCmd('${esc(m.url).replace(/'/g, "\\'")}', '${esc(m.directory)}')">wget</button>`
            : '<span class="tpl-no-url">No download URL</span>';
          return `<div class="tpl-model-row">
            <span class="tpl-badge missing">missing</span>
            <span class="tpl-model-path">${esc(path)}</span>
            <span class="tpl-size"></span>
            ${dlBtn}
            ${wgetBtn}
          </div>`;
        }
      }).join('');

      const countColor = wf.models_missing > 0 ? 'var(--accent-red)' : 'var(--accent-green)';
      const countText = `${wf.models_on_disk}/${wf.models_total} on disk`;

      return `<div class="tpl-workflow-card">
        <div class="tpl-workflow-header">
          <span class="tpl-filename">${esc(wf.filename)}</span>
          <span class="tpl-counts" style="color:${countColor}">${countText}</span>
        </div>
        ${tplTags ? `<div class="tpl-subgraphs">${tplTags}</div>` : ''}
        ${modelRows || '<div style="padding:12px 16px;font-size:12px;color:var(--text-muted)">No model dependencies detected</div>'}
      </div>`;
    }).join('');

  } catch (e) {
    panel.innerHTML = `<div class="empty-state">Failed: ${esc(e.message)}</div>`;
  }
}

function copyDownloadCmd(url, directory) {
  const cmd = `wget -c -P /mnt/sfs/models/shared/${directory}/ "${url}"`;
  navigator.clipboard.writeText(cmd).then(() => {
    toast('wget command copied to clipboard', 'success');
  }).catch(() => {
    // Fallback for non-HTTPS or denied clipboard
    const ta = document.createElement('textarea');
    ta.value = cmd;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    toast('wget command copied to clipboard', 'success');
  });
}


// ============================================================
// MODEL DOWNLOADS
// ============================================================

let dlEventSource = null;
let checkedModels = null;

function humanSize(bytes) {
  if (bytes == null || bytes === 0) return '0 B';
  const units = ['B', 'KB', 'MB', 'GB', 'TB'];
  let i = 0;
  let val = bytes;
  while (val >= 1024 && i < units.length - 1) { val /= 1024; i++; }
  return val.toFixed(1) + ' ' + units[i];
}

async function checkModels() {
  const panel = document.getElementById('tpl-workflows');
  panel.innerHTML = '<div class="empty-state"><div class="spinner"></div><br>Checking model downloads & gated status...</div>';

  try {
    const data = await api('/api/models/check');
    checkedModels = data;
    const models = data.models || [];
    const summary = data.summary || {};

    // Update summary cards
    document.getElementById('tpl-on-disk').textContent = summary.on_disk || 0;
    document.getElementById('tpl-missing').textContent = summary.missing || 0;
    document.getElementById('tpl-missing').style.color = (summary.missing || 0) > 0 ? 'var(--accent-red)' : 'var(--accent-green)';

    // Show/hide download all button
    const dlAllBtn = document.getElementById('btn-dl-all');
    dlAllBtn.style.display = (summary.downloadable || 0) > 0 ? '' : 'none';

    // Render model list grouped by status
    const onDisk = models.filter(m => m.on_disk);
    const downloadable = models.filter(m => !m.on_disk && m.gated_info && m.gated_info.accessible && m.url);
    const gated = models.filter(m => !m.on_disk && m.gated_info && m.gated_info.gated && !m.gated_info.accessible);
    const noUrl = models.filter(m => !m.on_disk && !m.url);

    let html = '';

    if (summary.gated_needs_action > 0) {
      html += `<div style="padding:12px;margin-bottom:12px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:var(--radius);font-size:12px;color:var(--accent-amber)">
        ${summary.gated_needs_action} model(s) require license acceptance on HuggingFace before downloading.
        ${summary.hf_token_set ? '' : ' Set HF_TOKEN in .env for authenticated downloads.'}
      </div>`;
    }

    // Downloadable
    if (downloadable.length > 0) {
      html += `<div style="font-size:12px;color:var(--accent-green);margin-bottom:8px;font-weight:600">READY TO DOWNLOAD (${downloadable.length})</div>`;
      html += downloadable.map(m => {
        const path = (m.directory ? m.directory + '/' : '') + m.filename;
        const sizeStr = m.gated_info && m.gated_info.content_length ? humanSize(m.gated_info.content_length) : '';
        return `<div class="tpl-model-row">
          <span class="tpl-badge missing">missing</span>
          <span class="tpl-model-path">${esc(path)}</span>
          <span class="tpl-size">${esc(sizeStr)}</span>
          <button class="tpl-dl-btn" onclick="downloadSingleModel('${esc(m.directory)}','${esc(m.filename)}','${esc(m.url).replace(/'/g, "\\'")}')">DL</button>
          <button class="tpl-copy-btn" onclick="copyDownloadCmd('${esc(m.url).replace(/'/g, "\\'")}', '${esc(m.directory)}')">wget</button>
        </div>`;
      }).join('');
    }

    // Gated
    if (gated.length > 0) {
      html += `<div style="font-size:12px;color:var(--accent-amber);margin:16px 0 8px;font-weight:600">GATED - NEEDS LICENSE (${gated.length})</div>`;
      html += gated.map(m => {
        const path = (m.directory ? m.directory + '/' : '') + m.filename;
        const modelPage = m.gated_info && m.gated_info.model_page ? m.gated_info.model_page : '';
        return `<div class="tpl-model-row">
          <span class="tpl-gated-warning">${modelPage ? `<a href="${esc(modelPage)}" target="_blank" rel="noopener">GATED</a>` : 'GATED'}</span>
          <span class="tpl-model-path">${esc(path)}</span>
          <span class="tpl-size"></span>
          ${modelPage ? `<a href="${esc(modelPage)}" target="_blank" rel="noopener" style="font-size:10px;color:var(--accent-amber)">Accept License</a>` : ''}
        </div>`;
      }).join('');
    }

    // No URL
    if (noUrl.length > 0) {
      html += `<div style="font-size:12px;color:var(--text-muted);margin:16px 0 8px;font-weight:600">NO DOWNLOAD URL (${noUrl.length})</div>`;
      html += noUrl.map(m => {
        const path = (m.directory ? m.directory + '/' : '') + m.filename;
        return `<div class="tpl-model-row">
          <span class="tpl-badge missing">missing</span>
          <span class="tpl-model-path">${esc(path)}</span>
          <span class="tpl-no-url">No URL in workflow</span>
        </div>`;
      }).join('');
    }

    // On disk
    if (onDisk.length > 0) {
      html += `<div style="font-size:12px;color:var(--accent-green);margin:16px 0 8px;font-weight:600">ON DISK (${onDisk.length})</div>`;
      html += onDisk.map(m => {
        const path = (m.directory ? m.directory + '/' : '') + m.filename;
        return `<div class="tpl-model-row">
          <span class="tpl-badge on-disk">on disk</span>
          <span class="tpl-model-path">${esc(path)}</span>
          <span class="tpl-size">${m.file_size_human ? esc(m.file_size_human) : ''}</span>
        </div>`;
      }).join('');
    }

    // Orphaned (on disk but not referenced by any workflow)
    const orphaned = data.orphaned || [];
    if (orphaned.length > 0) {
      const orphanSize = orphaned.reduce((sum, m) => sum + (m.file_size || 0), 0);
      html += `<div style="font-size:12px;color:var(--accent-amber);margin:16px 0 8px;font-weight:600">ORPHANED - NOT IN ANY WORKFLOW (${orphaned.length} files, ${humanSize(orphanSize)})</div>`;
      html += `<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">These model files are on disk but not referenced by any workflow template. They may be safe to delete.</div>`;
      html += orphaned.map(m => {
        const path = (m.directory ? m.directory + '/' : '') + m.filename;
        return `<div class="tpl-model-row">
          <span class="tpl-badge" style="background:rgba(245,158,11,0.15);color:var(--accent-amber)">orphan</span>
          <span class="tpl-model-path">${esc(path)}</span>
          <span class="tpl-size">${m.file_size_human ? esc(m.file_size_human) : ''}</span>
          <button class="tpl-dl-btn" style="background:rgba(239,68,68,0.2);color:var(--accent-red)" onclick="deleteModel('${esc(m.directory)}','${esc(m.filename)}','${m.file_size_human ? esc(m.file_size_human) : "?"}')">DEL</button>
        </div>`;
      }).join('');
    }

    panel.innerHTML = html || '<div class="empty-state">No models found in workflow templates.</div>';

  } catch (e) {
    panel.innerHTML = `<div class="empty-state">Failed: ${esc(e.message)}</div>`;
  }
}

async function downloadAllMissing() {
  showModal(
    'Download All Missing Models',
    'Start downloading all accessible missing models? This may take a while for large files.',
    async () => {
      try {
        await api('/api/models/download', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({}),
        });
        startDownloadStream();
      } catch (e) {
        toast('Download start failed: ' + e.message, 'error');
      }
    }
  );
}

async function downloadSingleModel(directory, filename, url) {
  if (_download_state_active) {
    toast('A download is already in progress', 'error');
    return;
  }
  // Pre-check gated status before attempting download
  try {
    toast('Checking download access...', 'info');
    const checkData = await api('/api/models/check');
    const match = (checkData.models || []).find(
      m => m.directory === directory && m.filename === filename
    );
    if (match && match.gated_info && match.gated_info.gated && !match.gated_info.accessible) {
      const page = match.gated_info.model_page || '';
      toast('Model is gated  accept license on HuggingFace first', 'error');
      if (page) window.open(page, '_blank');
      return;
    }
  } catch (e) {
    // Check failed  proceed anyway, download will fail with clear error
  }
  try {
    await api('/api/models/download', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ models: [{ directory, filename, url }] }),
    });
    startDownloadStream();
  } catch (e) {
    toast('Download start failed: ' + e.message, 'error');
  }
}

async function deleteModel(directory, filename, sizeStr) {
  showModal(
    'Delete Orphaned Model',
    `Permanently delete <strong>${esc(directory)}/${esc(filename)}</strong> (${esc(sizeStr)})? This cannot be undone.`,
    async () => {
      try {
        const result = await api('/api/models/delete', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ directory, filename }),
        });
        toast(`Deleted ${directory}/${filename} (${result.size_human})`, 'success');
        checkModels(); // refresh the list
      } catch (e) {
        toast('Delete failed: ' + e.message, 'error');
      }
    }
  );
}

let _download_state_active = false;

function startDownloadStream() {
  // Show progress panel
  document.getElementById('dl-panel').style.display = '';
  document.getElementById('dl-console').innerHTML = '';
  document.getElementById('dl-cancel-btn').disabled = false;
  _download_state_active = true;

  // Close existing stream
  if (dlEventSource) { dlEventSource.close(); dlEventSource = null; }

  const url = BASE + '/api/models/download/stream';
  dlEventSource = new EventSource(url);

  dlEventSource.addEventListener('log', (e) => {
    const console_el = document.getElementById('dl-console');
    const line = document.createElement('div');
    const text = e.data || '';
    if (text.includes('Error') || text.includes('failed') || text.includes('HTTP ')) {
      line.className = 'dl-log-error';
    } else if (text.includes('Completed:') || text.includes('successfully')) {
      line.className = 'dl-log-ok';
    }
    line.textContent = text;
    console_el.appendChild(line);
    console_el.scrollTop = console_el.scrollHeight;
  });

  dlEventSource.addEventListener('progress', (e) => {
    try {
      const d = JSON.parse(e.data);
      const filename = d.current_file || 'Waiting...';
      document.getElementById('dl-filename').textContent =
        (d.current_directory ? d.current_directory + '/' : '') + filename;
      document.getElementById('dl-file-counter').textContent =
        `${d.files_completed}/${d.files_total}`;

      if (d.bytes_total > 0) {
        const pct = Math.min(100, Math.round((d.bytes_downloaded / d.bytes_total) * 100));
        document.getElementById('dl-progress-bar').style.width = pct + '%';
        document.getElementById('dl-pct').textContent = pct + '%';
        document.getElementById('dl-size-info').textContent =
          humanSize(d.bytes_downloaded) + ' / ' + humanSize(d.bytes_total);
      } else {
        document.getElementById('dl-progress-bar').style.width = '0%';
        document.getElementById('dl-pct').textContent = '';
        document.getElementById('dl-size-info').textContent = '';
      }
    } catch (err) { /* ignore parse errors */ }
  });

  dlEventSource.addEventListener('complete', (e) => {
    _download_state_active = false;
    document.getElementById('dl-cancel-btn').disabled = true;
    try {
      const d = JSON.parse(e.data);
      if (d.cancelled) {
        toast(`Download cancelled: ${d.files_completed}/${d.files_total} completed`, 'info');
      } else if (d.files_failed > 0) {
        toast(`Download done with errors: ${d.files_completed}/${d.files_total} OK, ${d.files_failed} failed`, 'error');
      } else {
        toast(`All ${d.files_completed} model(s) downloaded`, 'success');
      }
    } catch (err) {
      toast('Download completed', 'success');
    }
    if (dlEventSource) { dlEventSource.close(); dlEventSource = null; }
  });

  dlEventSource.addEventListener('error', (e) => {
    // SSE error could be connection drop or actual error event
    if (e.data) {
      const console_el = document.getElementById('dl-console');
      const line = document.createElement('div');
      line.className = 'dl-log-error';
      line.textContent = e.data;
      console_el.appendChild(line);
    }
    _download_state_active = false;
    if (dlEventSource) { dlEventSource.close(); dlEventSource = null; }
  });
}

async function cancelDownload() {
  showModal('Cancel Download', 'Cancel the current download? Partially downloaded files can be resumed later.', async () => {
    try {
      await api('/api/models/download/cancel', { method: 'POST' });
      document.getElementById('dl-cancel-btn').disabled = true;
      toast('Cancel requested', 'info');
    } catch (e) { toast('Cancel failed: ' + e.message, 'error'); }
  });
}

async function checkActiveDownload() {
  try {
    const status = await api('/api/models/download/status');
    if (status.active) {
      _download_state_active = true;
      startDownloadStream();
    }
  } catch (e) { /* ignore */ }
}


// ============================================================
// LIVE STATUS & POLLING
// ============================================================

function updateLive(connected) {
  const dot = document.getElementById('live-dot');
  const text = document.getElementById('live-text');
  if (connected) {
    dot.classList.remove('disconnected');
    text.textContent = 'Live';
  } else {
    dot.classList.add('disconnected');
    text.textContent = 'Reconnecting...';
  }
}

// Polling (every 10s for system status, tabs refresh on switch)
function startPolling() {
  loadSystemStatus();
  loadContainers();

  pollInterval = setInterval(() => {
    loadSystemStatus();
    if (currentTab === 'queue') { loadQueueStatus(); loadJobs(); }
  }, 10000);
}

// ---- Initialize ----
startPolling();
</script>
</body>
</html>
