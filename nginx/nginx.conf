user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # Performance optimizations
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 500M;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript
               application/json application/javascript application/xml+rss
               application/rss+xml font/truetype font/opentype
               application/vnd.ms-fontobject image/svg+xml;

    # SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Include generated upstreams and URL encoding maps (Issue #54)
    include /etc/nginx/conf.d/user-upstreams.conf;
    include /etc/nginx/conf.d/user-maps.conf;

    # Cookie-based auth persistence (#45)
    # Generated at startup — maps session cookie to auth bypass
    include /etc/nginx/conf.d/auth-cookie-map.conf;

    # Queue Manager upstream
    upstream queue-manager {
        server queue-manager:3000;
    }

    # Admin Dashboard upstream
    upstream admin {
        server admin:8080;
    }

    # HTTP to HTTPS redirect
    server {
        listen 80;
        server_name _;

        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    # HTTPS server
    server {
        listen 443 ssl;
        http2 on;
        server_name _;

        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;

        # HTTP Basic Auth — cookie bypass when AUTH_COOKIE_SECRET is set (#45)
        # $auth_bypass = "off" if valid session cookie present, else realm string
        auth_basic $auth_bypass;
        auth_basic_user_file /etc/nginx/.htpasswd;

        # Set session cookie after successful auth (#45)
        # Generated at startup — includes cookie secret from env
        include /etc/nginx/conf.d/auth-cookie-header.conf;

        # Favicon - ComfyUI logo (yellow C on blue), no auth required
        location = /favicon.ico {
            auth_basic off;
            access_log off;
            default_type image/svg+xml;
            return 200 '<svg width="84" height="84" viewBox="0 0 84 84" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="84" height="84" fill="#172DD7"/><path d="M28.5899 69.2727C27.3242 69.2727 26.303 68.8023 25.637 67.9128C24.9524 66.9989 24.774 65.723 25.1471 64.4133L26.6455 59.1518C26.765 58.7329 26.6818 58.2821 26.4212 57.9336C26.1606 57.5858 25.7529 57.381 25.3198 57.381H21.0116C19.7453 57.381 18.724 56.9112 18.0583 56.0218C17.3738 55.1072 17.1953 53.8314 17.5687 52.5216L22.7163 34.5286L23.2847 32.5517C24.0487 29.869 26.8349 27.6888 29.4966 27.6888H34.6517C35.2668 27.6888 35.8079 27.2787 35.9773 26.6835L37.6821 20.6987C38.4453 18.0187 41.2316 15.8385 43.8933 15.8385L54.9181 15.8189L62.9891 15.8182C64.2551 15.8182 65.2763 16.288 65.942 17.1774C66.6265 18.0913 66.805 19.3672 66.4319 20.6769L64.124 28.7803C63.3611 31.4595 60.5748 33.6391 57.9131 33.6391L46.8637 33.6601H41.7104C41.0959 33.6601 40.5555 34.0695 40.3851 34.6641L36.0883 49.6722C35.9681 50.0919 36.0513 50.5441 36.3126 50.8925C36.5732 51.2403 36.9809 51.445 37.4136 51.445L44.7152 51.4308H52.7622C54.0282 51.4308 55.0494 51.9006 55.7151 52.7901C56.3996 53.7046 56.5781 54.9805 56.2047 56.2902L53.8969 64.3923C53.1339 67.0722 50.3476 69.2517 47.686 69.2517L36.6369 69.2727H28.5899Z" fill="#F0FF41"/></svg>';
        }

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;

        # Admin dashboard - trailing slash on proxy_pass strips /admin/ prefix
        location = /admin {
            return 301 /admin/;
        }
        location /admin/ {
            proxy_pass http://admin/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # Disable buffering for SSE (model download progress)
            proxy_buffering off;
            proxy_cache off;
        }

        # Queue Manager API (no trailing slash — preserves /api/ prefix)
        # Auth disabled: job submissions come from user frontends via fetch()
        # which won't have Basic Auth credentials for this path.
        # Queue-manager validates user_id in the request body.
        location /api/ {
            auth_basic off;
            proxy_pass http://queue-manager;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Long timeout for serverless inference (cold start + generation)
            proxy_read_timeout 600s;
            proxy_send_timeout 600s;

            # CORS headers for API - Security: Only allow specific origins
            # Note: CORS is also configured in FastAPI backend
            add_header Access-Control-Allow-Origin "https://aiworkshop.art" always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;

            if ($request_method = OPTIONS) {
                return 204;
            }
        }

        # WebSocket endpoint for queue updates
        location /ws {
            proxy_pass http://queue-manager/ws;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_read_timeout 86400;
            proxy_send_timeout 86400;
        }

        # Static outputs (for downloading generated files)
        location /outputs/ {
            alias /var/www/outputs/;
            autoindex on;
            autoindex_exact_size off;
            autoindex_localtime on;
        }

        # Health check dashboard (no auth required)
        location = /health {
            auth_basic off;
            root /usr/share/nginx/html;
            try_files /health.html =404;
        }

        # Simple health ping (for scripts, no auth)
        location = /health/ping {
            auth_basic off;
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # Static assets — no auth needed (#78)
        # Browser auto-fetches manifest.json, CSS, JS without Basic Auth credentials
        # These are build artifacts with content-hashed filenames — no security risk
        location ~ ^/(?<user_id>user[0-9][0-9][0-9])/assets/(?<asset_path>.+)$ {
            auth_basic off;
            resolver 127.0.0.11 valid=30s;
            set $backend_assets $user_id;
            proxy_pass http://$backend_assets:8188/assets/$asset_path$is_args$args;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Include generated user frontend locations
        include /etc/nginx/conf.d/user-locations.conf;

        # Root
        location / {
            root /usr/share/nginx/html;
            index index.html;
        }
    }
}
