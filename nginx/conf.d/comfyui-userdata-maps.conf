# Maps to preserve URL encoding for ComfyUI userdata API
# Issue #54: POST to /userdata returns 405 through nginx
#
# Root Cause:
# - When proxy_pass has trailing slash (http://backend/), nginx decodes URL-encoded characters
# - ComfyUI uses path parameters like /userdata/workflows/file.json
# - Slashes in filenames must be encoded as %2F
# - Nginx decodes %2F to / before proxying, breaking the route matching
#
# Solution:
# - Use $request_uri which contains the raw, un-decoded URI
# - Extract path portion with map directive, preserving encoding
# - Pass to proxy_pass without trailing slash
#
# Reference: https://github.com/comfyanonymous/ComfyUI/pull/6376

# Extract raw path for each user (preserves %2F encoding)
map $request_uri $user001_raw_path {
    ~^/user001(/[^\?]*)  $1;
    default /;
}

map $request_uri $user002_raw_path { ~^/user002(/[^\?]*) $1; default /; }
map $request_uri $user003_raw_path { ~^/user003(/[^\?]*) $1; default /; }
map $request_uri $user004_raw_path { ~^/user004(/[^\?]*) $1; default /; }
map $request_uri $user005_raw_path { ~^/user005(/[^\?]*) $1; default /; }
map $request_uri $user006_raw_path { ~^/user006(/[^\?]*) $1; default /; }
map $request_uri $user007_raw_path { ~^/user007(/[^\?]*) $1; default /; }
map $request_uri $user008_raw_path { ~^/user008(/[^\?]*) $1; default /; }
map $request_uri $user009_raw_path { ~^/user009(/[^\?]*) $1; default /; }
map $request_uri $user010_raw_path { ~^/user010(/[^\?]*) $1; default /; }
map $request_uri $user011_raw_path { ~^/user011(/[^\?]*) $1; default /; }
map $request_uri $user012_raw_path { ~^/user012(/[^\?]*) $1; default /; }
map $request_uri $user013_raw_path { ~^/user013(/[^\?]*) $1; default /; }
map $request_uri $user014_raw_path { ~^/user014(/[^\?]*) $1; default /; }
map $request_uri $user015_raw_path { ~^/user015(/[^\?]*) $1; default /; }
map $request_uri $user016_raw_path { ~^/user016(/[^\?]*) $1; default /; }
map $request_uri $user017_raw_path { ~^/user017(/[^\?]*) $1; default /; }
map $request_uri $user018_raw_path { ~^/user018(/[^\?]*) $1; default /; }
map $request_uri $user019_raw_path { ~^/user019(/[^\?]*) $1; default /; }
map $request_uri $user020_raw_path { ~^/user020(/[^\?]*) $1; default /; }
